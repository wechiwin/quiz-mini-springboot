<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Studiamo l'italiano</title>
    <!--    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>-->
    <script type="text/javascript" th:src="@{/static/js/jquery.min.js}"></script>
    <!--    <script type="text/javascript" src="https://cdn.bootcss.com/vue/2.5.17-beta.0/vue.js"></script>-->
    <script type="text/javascript" th:src="@{/static/js/vue@2.6.20.min.js}"></script>
</head>
<body>

<div id="app">
    <div class="header">
        <a th:href="@{/}" class="header-text">Studiamo!</a>
    </div>

    <div v-if="loading" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="content">
        <div v-if="showModifyQuestionContent">
            <h3>
                Modifica domande
            </h3>
            <div class="right">
                <button @click="handleDownloadTemplate">Scarica Template ↓</button>
                <input type="file" ref="fileInput" style="display: none" @change="handleFileChange">
                <button @click="handleUploadTemplate" :disabled="loading">Carica Template ↑</button>
                <button @click="handleAddQuestions">Aggiunge +</button>
                <button @click="handleGoBackFolder">Torna↩️</button>
            </div>
            <!--        问题 table-->
            <table class="list-table" v-show="showModifyQuestionContent">
                <thead>
                <tr>
                    <th>Verbo</th>
                    <th>Personale</th>
                    <th>Congiungazione</th>
                    <th>Esempi</th>
                    <th>Modifica</th>
                </tr>
                </thead>
                <tbody>
                <tr v-for="(item, index) in questionList" :key="item.caPkid">
                    <td>{{ item.verb }}</td>
                    <td>{{ item.grammaticalPerson }}</td>
                    <td>{{ item.conjugation }}</td>
                    <td>{{ item.egSentence }}</td>
                    <td>
                        <button @click="handleEditQuestion(index)">Modifica</button>
                        <button @click="handleDeleteQuestion(index)" :disabled="itemDeleting" class="deleteButton">
                            Elimina
                        </button>
                    </td>
                </tr>
                </tbody>
            </table>

        </div>

        <div v-else>
            <h3>
                Modifica Categorie
            </h3>

            <div class="right">
                <button @click="handleAddFolder">Aggiunge +</button>
            </div>

            <!--        folder table -->
            <table class="list-table">
                <thead>
                <tr>
                    <th>Categorie</th>
                    <th>Modifica</th>
                </tr>
                </thead>
                <tbody>
                <tr v-for="(item, index) in list" :key="index">
                    <td @click="handleGoToQuestions(index)" class="manage-folder-name">{{ item.foName }}</td>
                    <td>
                        <button @click="handleEditFolderName(index)">Modifica</button>
                        <!--                        <button @click="handleGoToQuestions(index)">Modifica Domande</button>-->
                        <button @click="deleteItem(index)" :disabled="itemDeleting" class="deleteButton">Elimina
                        </button>
                    </td>
                </tr>
                </tbody>
            </table>

        </div>


        <div class="dialog" v-show="showUpdateDialog">
            <h3>Modifica Categorie</h3>
            <input type="text" v-model="newCategoryName"
                   style="width: 100%; box-sizing: border-box; margin-bottom: 10px;">
            <button id="promptOkBtn" @click="handleClickOk(currentIndex)">OK</button>
            <button id="promptCancelBtn" @click="handleClickCancel">Annulla</button>
        </div>

        <div class="dialog" v-show="showAddDialog">
            <h3>Add Categorie</h3>
            <input type="text" v-model="newCategoryName"
                   style="width: 100%; box-sizing: border-box; margin-bottom: 10px;">
            <button id="promptOkBtn" @click="handleClickAdd">Add</button>
            <button id="promptCancelBtn" @click="handleClickCancelAdd">Annulla</button>
        </div>

        <div class="dialog" v-show="showQuestionDialog">
            <h3>Domande</h3>
            <div class="input-question">
                <span>Verbo:</span>
                <input type="text" v-model="addQuestion.verb">
            </div>
            <div class="input-question">
                <span>Personale:</span>
                <input type="text" v-model="addQuestion.grammaticalPerson">
            </div>
            <div class="input-question">
                <span>Congiungazione:</span>
                <input type="text" v-model="addQuestion.conjugation">
            </div>
            <div class="input-question">
                <span>Esempi:</span>
                <input type="text" v-model="addQuestion.egSentence">
            </div>

            <button @click="handleClickQuestionOK">OK</button>
            <button @click="handleClickQuestionCancel">Annulla</button>
        </div>


    </div>


</div>

<script type="text/javascript">
    new Vue({
        el: '#app',
        data() {
            return {
                loading: false,
                list: [],
                questionList: [],
                itemDeleting: false,
                showUpdateDialog: false,
                newCategoryName: '',
                currentIndex: null,
                showQuestionDialog: false,
                showModifyQuestionContent: false,
                showAddDialog: false,
                addQuestion: {
                    foPkid: 0,
                    grammaticalPerson: "",
                    verb: "",
                    conjugation: "",
                    egSentence: "",
                },
                isUpdateQuestion: false,

            }

        },
        mounted() {
            this.getList();
        },
        methods: {
            handleFileChange(event) {
                const file = event.target.files[0];

                if (file) {
                    this.loading = true
                    const formData = new FormData();
                    formData.append('file', file);

                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', '/quiz/card/upload', true);

                    xhr.onreadystatechange = () => {
                        if (xhr.readyState === 4) {
                            // 隐藏loading效果
                            this.loading = false;

                            if (xhr.status === 200) {
                                console.log('上传成功', xhr.responseText);
                                this.getQuestions()
                            } else {
                                console.error('上传失败', xhr.statusText);
                            }
                        }
                    };
                    xhr.send(formData);
                }
            },

            handleDownloadTemplate() {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/quiz/card/downloadTemplate', true);
                xhr.responseType = 'arraybuffer';

                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            const blob = new Blob([xhr.response], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
                            const link = document.createElement('a');

                            link.href = window.URL.createObjectURL(blob);
                            link.download = 'template.xlsx';
                            link.click();

                            window.URL.revokeObjectURL(link.href);
                        } else {
                            console.error('下载失败', xhr.statusText);
                        }
                    }
                };
                xhr.send();
            },
            handleUploadTemplate() {
                // 触发文件选择框点击
                this.$refs.fileInput.click();
            },
            handleDeleteQuestion(index) {
                if (confirm('Are you sure you want to delete this item?')) {
                    this.itemDeleting = true;
                    var _this = this
                    var param = this.questionList[index]
                    $.ajax({
                        type: "POST",
                        url: "/quiz/card/delete",
                        data: JSON.stringify(param),
                        dataType: "json",
                        contentType: "application/json",
                        success: function (result) {
                            if (result.status == 200) {
                                _this.getQuestions();
                                _this.itemDeleting = false;

                            }
                        }
                    });
                }

            },

            handleEditQuestion(index) {
                this.showQuestionDialog = true
                this.addQuestion = {...this.questionList[index]}
                console.log(' this.addQuestion', this.addQuestion)
                this.isUpdateQuestion = true
            },
            getQuestions() {
                var param = {
                    "foPkid": this.addQuestion.foPkid
                }
                var _this = this
                $.ajax({
                    type: "POST",
                    url: "/quiz/card/searchList",
                    data: JSON.stringify(param),
                    dataType: "json",
                    contentType: "application/json",
                    success: function (result) {
                        if (result.status == 200) {
                            // console.log(result)
                            _this.questionList = result.data
                        }
                    }
                });
            },
            handleClickQuestionOK() {
                console.log('handleClickQuestionOK', this.addQuestion)
                if (
                    this.addQuestion.grammaticalPerson &&
                    this.addQuestion.verb &&
                    this.addQuestion.conjugation
                ) {
                    var _this = this
                    var param = this.addQuestion
                    if (this.isUpdateQuestion) {
                        $.ajax({
                            type: "POST",
                            url: "/quiz/card/update",
                            data: JSON.stringify(param),
                            dataType: "json",
                            contentType: "application/json",
                            success: function (result) {
                                if (result.status == 200) {
                                    // console.log(result)
                                    // _this.questionList = result.data
                                    _this.getQuestions()
                                    _this.showQuestionDialog = false
                                    _this.isUpdateQuestion = false
                                }
                            }
                        });
                    } else {
                        $.ajax({
                            type: "POST",
                            url: "/quiz/card/add",
                            data: JSON.stringify(param),
                            dataType: "json",
                            contentType: "application/json",
                            success: function (result) {
                                if (result.status == 200) {
                                    // console.log(result)
                                    // _this.questionList = result.data
                                    _this.getQuestions()
                                    _this.showQuestionDialog = false
                                }
                            }
                        });
                    }
                } else {
                    alert('Please check your input!')
                }
            },

            handleClickQuestionCancel() {
                this.showQuestionDialog = false
                this.addQuestion.grammaticalPerson = ''
                this.addQuestion.verb = ''
                this.addQuestion.conjugation = ''
                this.addQuestion.egSentence = ''
            },
            handleAddQuestions() {
                this.showQuestionDialog = true
                this.addQuestion.grammaticalPerson = ''
                this.addQuestion.verb = ''
                this.addQuestion.conjugation = ''
                this.addQuestion.egSentence = ''
            },

            handleGoBackFolder() {
                this.showModifyQuestionContent = false
            },

            handleClickCancelAdd() {
                this.newCategoryName = ''
                this.showAddDialog = false

            },

            handleClickAdd() {
                if (this.newCategoryName) {
                    var _this = this
                    var param = {
                        "foName": this.newCategoryName,
                    };
                    $.ajax({
                        type: "POST",
                        url: "/quiz/folder/add",
                        data: JSON.stringify(param),
                        dataType: "json",
                        contentType: "application/json",
                        success: function (result) {
                            if (result.status == 200) {
                                // console.log(result)
                                // alert('Fatto!')
                                _this.getList();

                            }
                        }
                    });

                    this.newCategoryName = ''
                    this.showAddDialog = false
                } else {
                    alert('Cannot add blank folder name!')
                }
            },
            handleAddFolder() {
                this.showAddDialog = true
            },
            handleClickOk(index) {
                if (this.newCategoryName) {
                    // this.$set(this.list, index, {...this.list[index], foName: this.newCategoryName});
                    let currentFolder = this.list[index]
                    if (currentFolder.foName !== this.newCategoryName) {
                        var _this = this;
                        currentFolder.foName = this.newCategoryName
                        var param = currentFolder;
                        $.ajax({
                            type: "POST",
                            url: "/quiz/folder/update",
                            data: JSON.stringify(param),
                            dataType: "json",
                            contentType: "application/json",
                            success: function (result) {
                                if (result.status == 200) {
                                    console.log('handleClickOk--result', result)
                                    // alert('Fatto!')
                                }
                            }
                        });
                    }
                    this.showUpdateDialog = false
                } else {
                    alert('Name cannot be blank!')
                }
            },
            handleGoToQuestions(index) {
                this.showModifyQuestionContent = true
                this.addQuestion.foPkid = this.list[index].foPkid
                this.getQuestions()
            },

            handleEditFolderName(index) {
                // Implement your edit logic here
                this.showUpdateDialog = true
                this.newCategoryName = this.list[index].foName
                this.currentIndex = index
                $.ajax({
                    type: "POST",
                    url: "/quiz/card/searchList",
                    data: JSON.stringify(param),
                    dataType: "json",
                    contentType: "application/json",
                    success: function (result) {
                        if (result.status == 200) {
                            // console.log(result)
                            _this.getList();
                            _this.itemDeleting = false;
                            // alert('Fatto!')
                        }
                    }
                });
            },
            deleteItem(index) {
                if (confirm('Are you sure you want to delete this item?')) {
                    this.itemDeleting = true;
                    var _this = this
                    var param = this.list[index]

                    $.ajax({
                        type: "POST",
                        url: "/quiz/folder/delete",
                        data: JSON.stringify(param),
                        dataType: "json",
                        contentType: "application/json",
                        success: function (result) {
                            if (result.status == 200) {
                                // console.log(result)
                                _this.getList();
                                _this.itemDeleting = false;
                                // alert('Fatto!')
                            }
                        }
                    });
                }
            },

            handleClickCancel() {
                this.showUpdateDialog = false
                this.newCategoryName = ''
            },

            getList() {
                var _this = this;
                var param = _this.searchList;
                $.ajax({
                    type: "POST",
                    url: "/quiz/folder/searchList",
                    data: JSON.stringify(param),
                    dataType: "json",
                    contentType: "application/json",
                    success: function (result) {
                        if (result.status == 200) {
                            // console.log(result)
                            _this.list = result.data;
                        }
                    }
                });
            },
            handleToHome() {
                window.location.href = "/quiz";
            },
        }
    })
</script>

</body>
<style>
    body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
        'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
        sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        font-family: 'Arial', sans-serif;
        background-color: #f5f8fa;
        padding: 0;
    }

    .content {
        margin: 0 auto;
        text-align: center;
    }


    .header {
        padding: 10px 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        /*width: 100vw;*/
        /*background-color: #bcd2e8; !* Twitter-like blue background color *!*/
        /*border-bottom: 1px solid #0f89d1; !* Slightly darker border color *!*/
    }

    .header-text {
        color: #1da1f2;
        text-decoration: underline;
        text-align: center;
        display: block;
        font-size: 2em;
        margin-block-start: 0.67em;
        margin-block-end: 0.67em;
        margin-inline-start: 0px;
        margin-inline-end: 0px;
        font-weight: bold;
    }


    input {
        padding: 10px;
        margin: 5px;
        border: 1px solid #e1e8ed;
        border-radius: 5px;
        font-size: 16px;
        width: 26vw;
    }

    button {
        padding: 10px 20px;
        margin: 10px;
        border: none;
        border-radius: 25px;
        font-size: 16px;
        cursor: pointer;
        background-color: #1da1f2;
        color: #fff;
        transition: background-color 0.3s ease;
    }

    button:hover {
        background-color: #0e81d4;
    }

    button:disabled {
        background-color: darkgrey;
        cursor: not-allowed;
    }

    .deleteButton {
        background-color: firebrick;
    }

    .deleteButton:hover {
        background-color: darkgray;
    }

    .right {
        text-align: right;
        width: 60%;
        margin: 0 auto;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .loading-spinner {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    .manage-folder-name {
        cursor: pointer;
        text-decoration: underline;
    }

    .dialog {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #fff;
        padding: 20px;
        border: 1px solid #ccc;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .input-question {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
    }

    .list-table {
        width: 60%; /* Adjust the width as needed */
        margin: 20px auto; /* Center the table */
        border-collapse: collapse;
    }

    .list-table th,
    .list-table td {
        border: 1px solid #ccc;
        padding: 12px; /* Adjust the padding as needed */
        text-align: center;
    }

    .list-table th {
        background-color: #f2f2f2;
    }


    /*移动端*/
    @media screen and (max-width: 750px) {
        .list-content {
            list-style-type: none;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
            flex-direction: column;
            align-items: center;
            align-content: center;
        }

        .list-item {
            display: list-item;
            width: 200px;
            line-height: 40px;
            cursor: pointer;
            padding: 10px;
            margin: 10px;
            border: 1px solid #e1e8ed;
            border-radius: 5px;
            background-color: #ffffff;
            transition: background-color 0.3s ease;
            text-align: center;
            text-decoration: none;
            color: #000000;
        }

        .list-item:hover {
            background-color: #f5f8fa;
        }


    }

    /*PC端*/
    @media screen and (min-width: 751px) {
        .list-content {
            list-style-type: none;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
            flex-direction: column;
            height: 86vh;
            align-items: center;
            align-content: center;
        }

        .list-item {
            display: list-item;
            width: 200px;
            line-height: 40px;
            cursor: pointer;
            padding: 10px;
            margin: 10px;
            border: 1px solid #e1e8ed;
            border-radius: 5px;
            background-color: #ffffff;
            transition: background-color 0.3s ease;
            text-align: center;
            text-decoration: none;
            color: #000000;
        }

        .list-item:hover {
            background-color: #f5f8fa;
        }

    }

</style>
</html>